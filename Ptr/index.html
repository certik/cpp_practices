<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Ptr - C++ Practices</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">C++ Practices</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Ptr</a>
                    </li>
                
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li >
                    <a rel="next" href="..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                
            </ul>
            
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#performance-notes">Performance Notes</a></li>
        
            <li><a href="#type-traits">Type Traits</a></li>
        
    
        <li class="main "><a href="#example-1">Example 1</a></li>
        
    
        <li class="main "><a href="#example-2">Example 2</a></li>
        
    
        <li class="main "><a href="#example-3">Example 3</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="performance-notes">Performance Notes</h1>
<p>In order for a class wrapper to produce equivalent assembly as the wrapped type
(e.g. a raw pointer, integer, ...), it must satisfy certain traits that in
general are dependent on the platform ABI.</p>
<p>Any class (no matter how complicated) will be optimized out in all cases,
except when passed as an argument to or returned from a function. The argument
passing conventions depend on the platform ABI, but in general, simple types
like raw pointers or integers as well as small classes of certain type will be
passed in registers (i.e. by value), while big classes on a stack (by
reference).</p>
<p>Example1: g++ 4.8.2, 4.9.2, 5.1.0 on 64bit will pass classes by value if and
only if the class is
<a href="http://en.cppreference.com/w/cpp/concept/TriviallyCopyable">trivially
copyable</a> and its
size (measured using <code>sizeof</code>) is less or equal to 16 bytes.</p>
<p>Example2: icpc 15.0.1 on 64bit will pass by value if and only if the class is
<a href="http://en.cppreference.com/w/cpp/concept/TriviallyCopyable">trivially
copyable</a> and size
less or equal to 16 bytes.</p>
<p>Other platforms might differ. Some authors propose to pass classes by value if
they are trivially copyable as well as a <a href="http://en.cppreference.com/w/cpp/concept/StandardLayoutType">standard layout
type</a>. So it is
probably a good idea to make it trivially copyable as well as a standard layout
type.</p>
<h2 id="type-traits">Type Traits</h2>
<p>If the class is <a href="http://en.cppreference.com/w/cpp/concept/TriviallyCopyable">trivially
copyable</a>
(<a href="http://en.cppreference.com/w/cpp/types/is_trivially_copyable">std::is_trivially_copyable</a>)
as well as has a <a href="http://en.cppreference.com/w/cpp/language/default_constructor#Trivial_default_constructor">trivial default constructor</a>
(<a href="http://en.cppreference.com/w/cpp/types/is_default_constructible">std::is_trivially_default_constructible</a>)
then it is <a href="http://en.cppreference.com/w/cpp/concept/TrivialType">trivial</a>
(<a href="http://en.cppreference.com/w/cpp/types/is_trivial">std::is_trivial</a>).  If in
addition it is a <a href="http://en.cppreference.com/w/cpp/concept/StandardLayoutType">standard layout
type</a>
(<a href="http://en.cppreference.com/w/cpp/types/is_standard_layout">std::is_standard_layout</a>),
then it is a <a href="http://en.cppreference.com/w/cpp/concept/PODType">POD</a>
(<a href="http://en.cppreference.com/w/cpp/types/is_pod">std::is_pod</a>).</p>
<h1 id="example-1">Example 1</h1>
<p>Old:</p>
<pre><code class="c++">int *a;
{
    int b=1;
    a = &amp;b;
}
*a = 5; // Dangling, undefined behavior
</code></pre>

<p>New:</p>
<pre><code class="c++">Ptr&lt;int&gt; a;
{
#ifdef DEBUG_MODE
    UniquePtr&lt;int&gt; b(new int(1));
#else
    int b=1;
#endif
#ifdef DEBUG_MODE
    a = b.ptr();
#else
    a = ptrFromRef(b);
#endif
}
*a = 5; // Dangling, throws an exception in Debug mode
</code></pre>

<h1 id="example-2">Example 2</h1>
<p>Old:</p>
<pre><code class="c++">class A {
private:
    std::map&lt;int, int&gt; m;
public:
    std::map&lt;int, int&gt; *get_access() {
        return &amp;m;
    }
};
</code></pre>

<p>New:</p>
<pre><code class="c++">class A {
private:
#ifdef DEBUG_MODE
    UniquePtr&lt;std::map&lt;int, int&gt;&gt; m;
#else
    std::map&lt;int, int&gt; m;
#endif
public:
    Ptr&lt;std::map&lt;int, int&gt;&gt; get_access() {
#ifdef DEBUG_MODE
        return m.ptr();
#else
        return ptrFromRef(m);
#endif
    }
};
</code></pre>

<h1 id="example-3">Example 3</h1>
<p>Code (<a href="https://github.com/ricochet-im/ricochet/blob/9f769bf872d4198e7456203c9ffd44963c47fa46/src/core/IdentityManager.cpp#L97]">original</a>):</p>
<pre><code class="c++">UserIdentity *IdentityManager::lookupHostname(const QString &amp;hostname) const
{
    QString ohost = ContactIDValidator::hostnameFromID(hostname);
    if (ohost.isNull())
        ohost = hostname;

    if (!ohost.endsWith(QLatin1String(&quot;.onion&quot;)))
        ohost.append(QLatin1String(&quot;.onion&quot;));

    for (QList&lt;UserIdentity*&gt;::ConstIterator it = m_identities.begin(); it != m_identities.end(); ++it)
    {
        if (ohost.compare((*it)-&gt;hostname(), Qt::CaseInsensitive) == 0)
            return *it;
    }

    return 0;
}
</code></pre>

<p>Code (<a href="https://github.com/ricochet-im/ricochet/blob/9f769bf872d4198e7456203c9ffd44963c47fa46/src/core/ContactIDValidator.cpp#L65">original</a>):</p>
<pre><code class="c++">ContactUser *ContactIDValidator::matchingContact(const QString &amp;text) const
{
    ContactUser *u = 0;
    if (m_uniqueIdentity)
        u = m_uniqueIdentity-&gt;contacts.lookupHostname(text);
    return u;
}
</code></pre>

<p>And (<a href="https://github.com/ricochet-im/ricochet/blob/954d6ed397fcde73f19564d3c2f7f3dfcda7996d/src/core/UserIdentity.cpp#L203">original</a>):</p>
<pre><code class="c++">void UserIdentity::handleIncomingAuthedConnection(Connection *conn)
{
    if (conn-&gt;purpose() != Connection::Purpose::Unknown)
        return;

    QString clientName = conn-&gt;authenticatedIdentity(Connection::HiddenServiceAuth);
    if (clientName.isEmpty()) {
        BUG() &lt;&lt; &quot;Called to handle incoming authed connection without any authed name&quot;;
        return;
    }

    ContactUser *user = contacts.lookupHostname(clientName);
    if (!user) {
        // This client can start a contact request, for example. The purpose stays unknown, and the
        // connection will be killed if the purpose isn't changed before the timeout.
        qDebug() &lt;&lt; &quot;Have an incoming connection authenticated as unknown client&quot; &lt;&lt; clientName;
        return;
    }

    qDebug() &lt;&lt; &quot;Incoming connection authenticated as contact&quot; &lt;&lt; user-&gt;uniqueID &lt;&lt; &quot;with hostname&quot; &lt;&lt; clientName;
    user-&gt;assignConnection(conn);

    if (conn-&gt;parent() != user) {
        BUG() &lt;&lt; &quot;Connection wasn't claimed after authentication&quot;;
        conn-&gt;close();
    }
}
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>

        <!--
        MkDocs version  : 0.12.2
        Docs Build Date : 2015-06-02 18:10:43.890957
        -->
    </body>
</html>